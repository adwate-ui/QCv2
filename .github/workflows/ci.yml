name: CI - Build and Type Check

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  ci:
    runs-on: ubuntu-latest
    name: Build and Type Check
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Root Dependencies
        run: npm install

      - name: Install Pages Dependencies
        working-directory: pages
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install Worker Dependencies
        working-directory: workers/image-proxy
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Type Check Pages
        working-directory: pages
        run: npm run typecheck

      - name: Build Pages
        working-directory: pages
        run: npm run build

      - name: Verify Pages Build Output
        run: |
          echo "Verifying pages build output..."
          if [ ! -d "pages/dist" ]; then
            echo "❌ Error: pages/dist/ directory not found"
            exit 1
          fi
          
          HTML_COUNT=$(find pages/dist -name "*.html" | wc -l)
          if [ $HTML_COUNT -gt 0 ]; then
            echo "✅ Found $HTML_COUNT HTML file(s) in pages/dist/"
          else
            echo "⚠️  Warning: No HTML files found in pages/dist/"
            exit 1
          fi
          
          echo "✅ Pages build verification complete!"

      - name: Verify Workers Structure
        run: |
          echo "Verifying workers structure..."
          if [ ! -f "workers/image-proxy/index.mjs" ]; then
            echo "❌ Error: workers/image-proxy/index.mjs not found"
            exit 1
          fi
          
          if [ ! -f "workers/image-proxy/wrangler.toml" ]; then
            echo "❌ Error: workers/image-proxy/wrangler.toml not found"
            exit 1
          fi
          
          echo "✅ Workers structure verification complete!"

      - name: Summary
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "                    CI WORKFLOW SUMMARY                    "
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "  ✓ Dependencies installed"
          echo "  ✓ Type checks completed"
          echo "  ✓ Pages built"
          echo "  ✓ Workers structure verified"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
