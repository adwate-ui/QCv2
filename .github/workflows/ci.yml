name: CI - Build and Type Check

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  ci:
    runs-on: ubuntu-latest
    name: Build and Type Check
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json, using npm ci for deterministic install"
            npm ci
          else
            echo "No package-lock.json found, using npm install"
            npm install
          fi

      - name: Type Check All Projects
        run: |
          echo "Running type checks for all TypeScript projects..."
          echo ""
          echo "ğŸ“¦ Type checking shared package..."
          npm run typecheck
          echo ""
          echo "âœ… All type checks passed!"

      - name: Build Workers
        run: |
          echo "Building Cloudflare Workers..."
          npm run build:workers
          echo ""
          echo "âœ… Workers built successfully!"
          echo ""
          ls -lah dist/workers/ || echo "No workers output found"

      - name: Build Pages
        run: |
          echo "Building Cloudflare Pages (Frontend)..."
          npm run build:pages
          echo ""
          echo "âœ… Pages built successfully!"
          echo ""
          ls -lah dist/ | head -20 || echo "No pages output found"

      - name: Verify Build Outputs
        run: |
          echo "Verifying build outputs..."
          echo ""
          
          # Check that dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist/ directory not found"
            exit 1
          fi
          
          echo "âœ… dist/ directory exists"
          
          # Check for workers output
          if [ -d "dist/workers" ]; then
            WORKER_COUNT=$(find dist/workers -name "*.js" | wc -l)
            echo "âœ… Found $WORKER_COUNT worker bundle(s) in dist/workers/"
            find dist/workers -name "*.js" -exec echo "  - {}" \;
          else
            echo "â„¹ï¸  No dist/workers/ directory (no workers to build)"
          fi
          
          echo ""
          
          # Check for pages output (HTML files)
          HTML_COUNT=$(find dist -name "*.html" | wc -l)
          if [ $HTML_COUNT -gt 0 ]; then
            echo "âœ… Found $HTML_COUNT HTML file(s) in dist/"
          else
            echo "âš ï¸  Warning: No HTML files found in dist/"
          fi
          
          # Check for JS bundles
          JS_COUNT=$(find dist -name "*.js" -not -path "dist/workers/*" | wc -l)
          if [ $JS_COUNT -gt 0 ]; then
            echo "âœ… Found $JS_COUNT JavaScript bundle(s) in dist/"
          fi
          
          echo ""
          echo "âœ… Build verification complete!"

      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "                    CI WORKFLOW SUMMARY                    "
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "  âœ“ Dependencies installed"
          echo "  âœ“ Type checks completed"
          echo "  âœ“ Workers built"
          echo "  âœ“ Pages built"
          echo "  âœ“ Build outputs verified"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
