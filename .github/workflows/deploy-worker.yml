name: Deploy Cloudflare Worker

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate wrangler configurations
        run: |
          echo "Checking for wrangler configuration conflicts..."
          .github/scripts/validate-wrangler-configs.sh
          echo "✓ Wrangler configurations are valid"

      - name: Install worker dependencies
        run: |
          cd worker
          npm install

      - name: Validate worker code
        run: |
          cd worker
          node --check index.mjs
          echo "✓ Worker code syntax is valid"

      - name: Publish worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cd worker
          echo "Deploying worker with wrangler@4..."
          npx wrangler@4 deploy
          echo "✓ Worker deployment command completed"
          echo ""
          echo "Expected worker URL: https://authentiqc-worker.adwate.workers.dev"
          echo "This URL MUST be set as VITE_IMAGE_PROXY_URL in your environment"

      - name: Verify worker deployment
        run: |
          echo "================================================================"
          echo "WORKER DEPLOYMENT VERIFICATION"
          echo "================================================================"
          echo ""
          echo "Waiting for worker to be available..."
          echo "This is CRITICAL - if this fails, the frontend will get CORS 404 errors"
          echo ""
          
          # Retry mechanism with exponential backoff
          MAX_RETRIES=6
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "─────────────────────────────────────────────────────────────────"
            echo "Verification Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            echo "─────────────────────────────────────────────────────────────────"
            
            # Test health check endpoint
            echo "Testing: https://authentiqc-worker.adwate.workers.dev/"
            HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" https://authentiqc-worker.adwate.workers.dev/ || echo "000")
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Worker is responding with 200 OK"
              echo ""
              echo "Response body:"
              cat /tmp/response.json | jq '.' || cat /tmp/response.json
              echo ""
              
              # Extract version from response
              VERSION=$(cat /tmp/response.json | jq -r '.version' 2>/dev/null || echo "unknown")
              echo "✓ Worker Version: $VERSION"
              
              SUCCESS=true
              break
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "✗ CRITICAL: Worker returned 404 Not Found"
              echo "   This means the worker is NOT deployed or the URL is wrong"
              echo "   Frontend will experience CORS 404 errors!"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((2 ** RETRY_COUNT))
                echo "   Waiting ${WAIT_TIME}s before retry..."
                sleep $WAIT_TIME
              fi
            else
              echo "⚠ Attempt $((RETRY_COUNT + 1)) failed with HTTP $HTTP_CODE"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((2 ** RETRY_COUNT))
                echo "Waiting ${WAIT_TIME}s before retry..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          echo ""
          echo "─────────────────────────────────────────────────────────────────"
          
          if [ "$SUCCESS" = false ]; then
            echo "✗✗✗ DEPLOYMENT VERIFICATION FAILED ✗✗✗"
            echo ""
            echo "Worker is NOT accessible after $MAX_RETRIES attempts"
            echo "This will cause CORS 404 errors in production!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Check Cloudflare Dashboard: https://dash.cloudflare.com"
            echo "2. Verify account_id in wrangler.toml matches your account"
            echo "3. Verify CF_API_TOKEN has correct permissions"
            echo "4. Check deployment logs above for errors"
            echo "5. Try manual deployment: cd worker && npx wrangler deploy"
            echo ""
            exit 1
          fi
          
          echo "✓✓✓ HEALTH CHECK PASSED ✓✓✓"
          echo ""
          
          # Check for CORS headers (case-insensitive)
          echo "─────────────────────────────────────────────────────────────────"
          echo "Checking CORS headers..."
          CORS=$(curl -s -I https://authentiqc-worker.adwate.workers.dev/ | tr '[:upper:]' '[:lower:]' | grep "access-control-allow-origin" || echo "")
          if [ -n "$CORS" ]; then
            echo "✓ CORS headers present: $CORS"
          else
            echo "✗ ERROR: CORS headers not found"
            echo "   Worker responses MUST include Access-Control-Allow-Origin header"
            echo "   Without this, frontend will get CORS policy errors"
            exit 1
          fi
          
          # Check X-Worker-Version header
          echo ""
          echo "Checking version header..."
          VERSION_HEADER=$(curl -s -I https://authentiqc-worker.adwate.workers.dev/ | grep -i "x-worker-version" || echo "")
          if [ -n "$VERSION_HEADER" ]; then
            echo "✓ Version header present: $VERSION_HEADER"
          else
            echo "⚠ Warning: X-Worker-Version header not found (not critical)"
          fi
          
          # Test fetch-metadata endpoint
          echo ""
          echo "─────────────────────────────────────────────────────────────────"
          echo "Testing fetch-metadata endpoint..."
          METADATA_CODE=$(curl -s -o /tmp/metadata.json -w "%{http_code}" "https://authentiqc-worker.adwate.workers.dev/fetch-metadata?url=https://www.cloudflare.com" || echo "000")
          
          echo "HTTP Status: $METADATA_CODE"
          
          if [ "$METADATA_CODE" = "200" ]; then
            echo "✓ fetch-metadata endpoint working correctly"
            echo ""
            echo "Response preview:"
            cat /tmp/metadata.json | jq '.images[0:3]' 2>/dev/null || cat /tmp/metadata.json | head -c 200
            echo ""
          elif [ "$METADATA_CODE" = "502" ] || [ "$METADATA_CODE" = "400" ]; then
            echo "✓ fetch-metadata endpoint is accessible (returned $METADATA_CODE)"
            echo "   A 502 or 400 response means the worker is running"
            echo "   (The test URL may have failed, but the endpoint exists)"
          elif [ "$METADATA_CODE" = "404" ]; then
            echo "✗ CRITICAL: fetch-metadata endpoint returned 404"
            echo "   This endpoint is missing or worker routing is broken"
            echo "   Frontend WILL fail when trying to import images from URLs"
            exit 1
          else
            echo "⚠ Warning: fetch-metadata returned unexpected status $METADATA_CODE"
            echo "   This may indicate a problem, but could also be a transient issue"
          fi
          
          echo ""
          echo "================================================================"
          echo "✓✓✓ ALL VERIFICATION CHECKS PASSED ✓✓✓"
          echo "================================================================"
          echo ""
          echo "Worker is deployed and accessible at:"
          echo "  https://authentiqc-worker.adwate.workers.dev"
          echo ""
          echo "This URL MUST be set as VITE_IMAGE_PROXY_URL in production"
          echo "================================================================"
